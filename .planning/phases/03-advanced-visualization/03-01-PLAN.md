---
phase: 03-advanced-visualization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/gridworld/server.py
  - static/index.html
  - static/styles.css
autonomous: true

must_haves:
  truths:
    - "Q-table data is transmitted via WebSocket after each episode"
    - "Toggle switches are visible in sidebar"
    - "Toggles default to OFF on page load"
  artifacts:
    - path: "src/gridworld/server.py"
      provides: "Q-table in episode_complete message"
      contains: "q_table"
    - path: "static/index.html"
      provides: "Toggle switch UI elements"
      contains: "heatmap-toggle"
    - path: "static/styles.css"
      provides: "Toggle switch styling"
      contains: "toggle-switch"
  key_links:
    - from: "src/gridworld/server.py"
      to: "episode_complete WebSocket message"
      via: "q_table field in broadcast data"
      pattern: "q_table.*tolist"
---

<objective>
Add Q-table WebSocket transmission and toggle switch UI infrastructure.

Purpose: Enable frontend to receive Q-table data for visualization and provide user controls to toggle overlays on/off.
Output: Backend sends Q-table with each episode_complete event; sidebar has two styled toggle switches.
</objective>

<execution_context>
@/Users/luckleineschaars/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luckleineschaars/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-advanced-visualization/03-CONTEXT.md
@.planning/phases/03-advanced-visualization/03-RESEARCH.md
@src/gridworld/server.py
@static/index.html
@static/styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Q-table to episode_complete WebSocket message</name>
  <files>src/gridworld/server.py</files>
  <action>
Modify the episode_complete broadcast in the training_loop function to include the Q-table data.

In the existing broadcast after episode completion (around line 172-180), add a q_table field:

```python
await manager.broadcast({
    "type": "episode_complete",
    "data": {
        "episode": episode + 1,
        "reward": total_reward,
        "steps": step,
        "epsilon": float(agent.epsilon),
        "q_table": agent.q_table.tolist(),  # NEW: Include Q-table for visualization
    },
})
```

The Q-table is a numpy array of shape (5, 5, 4) representing Q-values for each state-action pair.
Using .tolist() converts it to a JSON-serializable nested list structure.
This adds approximately 1KB of data per episode (100 floats), which is negligible for localhost.

Do NOT add throttling - per CONTEXT.md, update overlays every episode (not throttled).
  </action>
  <verify>
1. Run the server: `cd /Users/luckleineschaars/Repos/reinforcement-learning-solitaire && python -m uvicorn src.gridworld.server:app --reload`
2. Open browser console, connect to WebSocket
3. Start training for a few episodes
4. Verify episode_complete messages include q_table field as a 3D nested array
  </verify>
  <done>
episode_complete WebSocket messages include q_table field with Q-values as nested list [x][y][action]
  </done>
</task>

<task type="auto">
  <name>Task 2: Add toggle switches to sidebar UI</name>
  <files>static/index.html, static/styles.css</files>
  <action>
**In static/index.html:**

Add a new visualization toggles section in the sidebar, after the qtable-buttons div (around line 98):

```html
<div class="visualization-toggles">
    <h3>Visualization</h3>

    <div class="toggle-group">
        <label class="toggle-switch">
            <input type="checkbox" id="heatmap-toggle">
            <span class="toggle-slider"></span>
        </label>
        <span class="toggle-label">Q-Value Heatmap</span>
    </div>

    <div class="toggle-group">
        <label class="toggle-switch">
            <input type="checkbox" id="policy-toggle">
            <span class="toggle-slider"></span>
        </label>
        <span class="toggle-label">Policy Arrows</span>
    </div>
</div>
```

**In static/styles.css:**

Add toggle switch styles at the end of the file (before the responsive section):

```css
/* ============================================================================
   Visualization Toggle Switches
   ============================================================================ */

.visualization-toggles {
    margin-top: 1.2rem;
    padding-top: 1rem;
    border-top: 1px solid #e0e0e0;
}

.visualization-toggles h3 {
    font-size: 1.1rem;
    font-weight: 500;
    margin-bottom: 0.8rem;
    color: #333;
}

.toggle-group {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.6rem;
}

.toggle-switch {
    position: relative;
    display: inline-block;
    width: 44px;
    height: 24px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: 0.3s;
    border-radius: 24px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
}

input:checked + .toggle-slider {
    background-color: #4caf50;
}

input:checked + .toggle-slider:before {
    transform: translateX(20px);
}

.toggle-label {
    font-size: 0.9rem;
    color: #555;
}
```

Per CONTEXT.md: Both toggles default to OFF (unchecked) on page load. No keyboard shortcuts.
  </action>
  <verify>
1. Open http://localhost:8000 in browser
2. Verify "Visualization" section appears in sidebar below Q-table buttons
3. Verify two toggle switches are visible: "Q-Value Heatmap" and "Policy Arrows"
4. Verify both toggles are OFF (gray, slider on left) by default
5. Click each toggle - verify smooth slide animation and green color when ON
6. Refresh page - verify toggles reset to OFF (not persisted)
  </verify>
  <done>
Two toggle switches visible in sidebar with modern sliding style, both default to OFF, proper CSS styling matches existing UI
  </done>
</task>

</tasks>

<verification>
1. Server broadcasts episode_complete with q_table field
2. Toggle switches appear in sidebar with correct styling
3. Toggles are functional (click to toggle ON/OFF)
4. Toggles default to OFF on page load
</verification>

<success_criteria>
- episode_complete messages contain q_table as nested list
- Sidebar shows "Visualization" section with two toggle switches
- Toggle animations work smoothly
- No JavaScript errors in browser console
</success_criteria>

<output>
After completion, create `.planning/phases/03-advanced-visualization/03-01-SUMMARY.md`
</output>
